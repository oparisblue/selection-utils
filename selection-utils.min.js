class SelectionUtils{static getSelectedText(){return SelectionUtils.isAnythingSelected()?document.getSelection().toString():""}static getParentTags(){let e=[];if(SelectionUtils.isAnythingSelected(!0)){let t=document.getSelection().getRangeAt(0).commonAncestorContainer;for(;t!=document.body&&null!=t;)t.nodeType==Node.ELEMENT_NODE&&e.push(t),t=t.parentNode}return e}static containsTag(e,t){t=t.toUpperCase();for(let n of e)if(n.tagName.toUpperCase()==t)return!0;return!1}static makeSelection(e,t,n){if(null==e)return;let i=t;if(t=Math.min(t,n),n=Math.max(i,n),t<0||n<0)throw new Error("Both positions for the selection must be positive!");let l=document.createRange(),o=e,c=0,a=e,s=0,r=0,g=!0;for(let i of SelectionUtils.getAllTextNodes(e)){let e=r+i.textContent.length;if(g&&t<e&&(o=i,c=t-r,g=!1),!g&&n<=e){a=i,s=n-r;break}r=e}l.setStart(o,c),l.setEnd(a,s);let d=document.getSelection();d.removeAllRanges(),d.addRange(l)}static removeSelection(){SelectionUtils.isAnythingSelected(!0)&&document.getSelection().removeAllRanges()}static isAnythingSelected(e=!1){try{let t=document.getSelection().getRangeAt(0);return!!e||(t.startOffset!=t.endOffset||t.startContainer!=t.endContainer)}catch{return!1}}static isSelectionWithin(e,t=!1){if(null==e||!SelectionUtils.isAnythingSelected(t))return!1;let n=document.getSelection().getRangeAt(0).commonAncestorContainer;for(;;){if(e==n)return!0;if(n==document.body||null==n)return!1;n=n.parentNode}}static getSelectionPosition(e){if(!SelectionUtils.isSelectionWithin(e))return[];let t=document.getSelection().getRangeAt(0),n=0,i=0,l=0;for(let o of SelectionUtils.getAllTextNodes(e)){if(o==t.startContainer&&(n=l+t.startOffset),o==t.endContainer){i=l+t.endOffset;break}l+=o.textContent.length}return[n,i]}static toggleHTMLWrapping(e,t,n="",i=!1){let l=SelectionUtils.getSelectionPosition(e);if(0==l.length)return;t=t.toUpperCase();let o=document.getSelection().getRangeAt(0),c=document.createElement("SELECTION-DUMMY");c.appendChild(o.extractContents()),o.insertNode(c);let a=`<${t} ${n}>`,s=`</${t}>`,r=SelectionUtils.getParentTags(),g=SelectionUtils.containsTag(r,t);if(g){a="",s="";let e="",n="";for(let i of r){let l=i.tagName.toUpperCase();if(-1==SelectionUtils.cleanableTags.indexOf(l))continue;let o=i.outerHTML.split(">")[0]+">";a+=`</${l}>`,e=o+e,l!=t&&(n=o,s+=`</${l}>`)}a+=n,s+=e}e.innerHTML=e.innerHTML.replace(/<SELECTION-DUMMY>/gi,a).replace(/<\/SELECTION-DUMMY>/gi,s),SelectionUtils.cleanUpHTML(e),SelectionUtils.makeSelection(e,l[0],l[1]),g&&i&&SelectionUtils.toggleHTMLWrapping(e,t,n,!1)}static clearFormatting(e){let t=SelectionUtils.getSelectionPosition(e);if(0==t.length)return;let n=0,i=[],l=!1,o=!1,c="";for(let a of e.innerHTML){if("<"==a)l=!0,i.push(["","<",!1]);else if(l){let e=i.length-1,t=-1==i[e][1].indexOf(" ");">"==a?(l=!1,i[e][1]+=">",i[e][2]&&i.pop()):t&&"/"==a?(i[e][2]=!0,i.splice(e-1,1)):i[e][2]||(t&&" "!=a&&">"!=a&&(i[e][0]+=a.toUpperCase()),i[e][1]+=a)}else{if(n==t[0]){o=!0;for(let e=i.length-1;e>=0;e--)-1!=SelectionUtils.cleanableTags.indexOf(i[e][0])&&(c+=`</${i[e][0]}>`)}else if(n==t[1]){o=!1;for(let e of i)-1!=SelectionUtils.cleanableTags.indexOf(e[0])&&(c+=e[1])}n++}o&&(l||">"==a)||(c+=a)}e.innerHTML=c,SelectionUtils.cleanUpHTML(e),SelectionUtils.makeSelection(e,t[0],t[1])}static insertHTMLAtSelection(e,t){if(!SelectionUtils.isSelectionWithin(e,!0))return;let n=document.getSelection().getRangeAt(0);n.deleteContents();let i=document.createElement("SELECTION-DUMMY");n.insertNode(i),i.insertAdjacentHTML("afterend",t),i.remove()}static cleanUpHTML(e){let t=e.innerHTML;for(let n of SelectionUtils.cleanableTags)t=e.innerHTML.replace(new RegExp(`<${n}( [^>]*)?></${n}>`,"gi"),"");e.innerHTML=t;for(let t of e.childNodes)SelectionUtils.removeRedundantTags(t)}static removeRedundantTags(e){e.nodeType!=Node.TEXT_NODE&&-1!=SelectionUtils.cleanableTags.indexOf(e.tagName.toUpperCase())&&Array.from(e.getElementsByTagName(e.tagName)).forEach(e=>{SelectionUtils.removeRedundantTags(e),e.insertAdjacentHTML("afterend",e.innerHTML),e.remove()})}static getAllTextNodes(e){let t=[];for(let n of e.childNodes)n.nodeType==Node.TEXT_NODE?t.push(n):t=t.concat(SelectionUtils.getAllTextNodes(n));return t}}SelectionUtils.cleanableTags=[],window.addEventListener("load",()=>{document.addEventListener("selectionchange",()=>{SelectionUtils.isAnythingSelected(!0)&&document.getSelection().getRangeAt(0).commonAncestorContainer.dispatchEvent(new CustomEvent("selected",{bubbles:!0,cancelable:!0}))})});